{% extends "base.html" %}

{% block title %}Analytics - ProposalForge{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
<script src="https://cdn.jsdelivr.net/npm/marked@15.0.7/marked.min.js"></script>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Left Sidebar: Filters -->
    <div class="col-md-3">
        <div class="card shadow-sm mb-3" id="filter-card">
            <div class="card-header bg-navy text-white">
                <i class="bi bi-funnel"></i> Filters
            </div>
            <div class="card-body" id="analytics-filters">

                <!-- === Opportunity Filters === -->
                <div class="filter-section" data-tab="opportunities">
                    <!-- Date Range -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold small">Date Range</label>
                        <input type="date" class="form-control form-control-sm mb-1" id="filter-date-start" placeholder="Start">
                        <input type="date" class="form-control form-control-sm" id="filter-date-end" placeholder="End">
                    </div>

                    <!-- Status -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold small">Status</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="posted" id="status-posted" checked>
                            <label class="form-check-label small" for="status-posted">Posted</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="forecasted" id="status-forecasted" checked>
                            <label class="form-check-label small" for="status-forecasted">Forecasted</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="closed" id="status-closed">
                            <label class="form-check-label small" for="status-closed">Closed</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="archived" id="status-archived">
                            <label class="form-check-label small" for="status-archived">Archived</label>
                        </div>
                    </div>

                    <!-- Agency -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold small">Agency</label>
                        <input type="text" class="form-control form-control-sm mb-1" id="agency-search" placeholder="Search agencies...">
                        <div class="agency-list border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                            {% for a in agencies %}
                            {% if a.count > 0 %}
                            <div class="form-check agency-item">
                                <input class="form-check-input agency-cb" type="checkbox" value="{{ a.code }}" id="agency-{{ a.code }}">
                                <label class="form-check-label small" for="agency-{{ a.code }}">
                                    {{ a.name[:35] }} <span class="text-muted">({{ a.count }})</span>
                                </label>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Category -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold small">Funding Category</label>
                        <div class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                            {% for c in categories %}
                            <div class="form-check">
                                <input class="form-check-input category-cb" type="checkbox" value="{{ c.code }}" id="cat-{{ c.code }}">
                                <label class="form-check-label small" for="cat-{{ c.code }}">
                                    {{ c.name[:35] }} <span class="text-muted">({{ c.count }})</span>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Granularity -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold small">Time Granularity</label>
                        <select class="form-select form-select-sm" id="filter-granularity">
                            <option value="month" selected>Month</option>
                            <option value="quarter">Quarter</option>
                            <option value="year">Year</option>
                            <option value="week">Week</option>
                        </select>
                    </div>
                </div>

                <!-- === Researcher Filters === -->
                <div class="filter-section" data-tab="researchers" style="display:none;">
                    <!-- Department -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold small">Department</label>
                        <input type="text" class="form-control form-control-sm mb-1" id="dept-search" placeholder="Search departments...">
                        <div class="dept-list border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                            {% for d in departments %}
                            <div class="form-check dept-item">
                                <input class="form-check-input dept-cb" type="checkbox" value="{{ d.name }}" id="dept-{{ loop.index }}">
                                <label class="form-check-label small" for="dept-{{ loop.index }}">
                                    {{ d.name[:40] }} <span class="text-muted">({{ d.count }})</span>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Researcher Status -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold small">Researcher Status</label>
                        <div class="form-check">
                            <input class="form-check-input res-status-cb" type="checkbox" value="ACTIVE" id="res-status-active" checked>
                            <label class="form-check-label small" for="res-status-active">Active</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input res-status-cb" type="checkbox" value="INACTIVE" id="res-status-inactive">
                            <label class="form-check-label small" for="res-status-inactive">Inactive</label>
                        </div>
                    </div>

                    <!-- Keyword Search -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold small">Keyword Filter</label>
                        <input type="text" class="form-control form-control-sm" id="filter-keyword" placeholder="e.g. machine learning">
                    </div>
                </div>

                <!-- === Match Filters === -->
                <div class="filter-section" data-tab="matches" style="display:none;">
                    <!-- Min Score -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold small">Min Match Score: <span id="min-score-label">0</span></label>
                        <input type="range" class="form-range" id="filter-min-score" min="0" max="100" step="5" value="0">
                    </div>

                    <!-- Agency (match context) -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold small">Agency</label>
                        <input type="text" class="form-control form-control-sm mb-1" id="match-agency-search" placeholder="Search agencies...">
                        <div class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                            {% for a in agencies %}
                            {% if a.count > 0 %}
                            <div class="form-check match-agency-item">
                                <input class="form-check-input match-agency-cb" type="checkbox" value="{{ a.code }}" id="match-agency-{{ a.code }}">
                                <label class="form-check-label small" for="match-agency-{{ a.code }}">
                                    {{ a.name[:35] }} <span class="text-muted">({{ a.count }})</span>
                                </label>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Department (match context) -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold small">Department</label>
                        <input type="text" class="form-control form-control-sm mb-1" id="match-dept-search" placeholder="Search departments...">
                        <div class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                            {% for d in departments %}
                            <div class="form-check match-dept-item">
                                <input class="form-check-input match-dept-cb" type="checkbox" value="{{ d.name }}" id="match-dept-{{ loop.index }}">
                                <label class="form-check-label small" for="match-dept-{{ loop.index }}">
                                    {{ d.name[:40] }} <span class="text-muted">({{ d.count }})</span>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- === Chat Filters (greyed out placeholder) === -->
                <div class="filter-section" data-tab="chat" style="display:none;">
                    <p class="text-muted small fst-italic mb-0">Filters are not applicable for Ask AI. Ask natural language questions directly in the chat.</p>
                </div>

                <!-- Buttons -->
                <div class="d-grid gap-2 mt-3">
                    <button class="btn btn-navy btn-sm" id="btn-apply-filters">
                        <i class="bi bi-check-circle"></i> Apply Filters
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" id="btn-reset-filters">
                        <i class="bi bi-arrow-counterclockwise"></i> Reset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="col-md-9">
        <!-- KPI Summary Cards -->
        <div class="row row-cols-2 row-cols-md-4 row-cols-lg-7 g-2 mb-4" id="kpi-cards">
            <div class="col">
                <div class="card stat-card shadow-sm text-center">
                    <div class="card-body py-2">
                        <div class="text-muted small">Opportunities</div>
                        <h5 class="text-navy mb-0" id="kpi-total">--</h5>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card stat-card shadow-sm text-center">
                    <div class="card-body py-2">
                        <div class="text-muted small">Total Funding</div>
                        <h5 class="text-navy mb-0" id="kpi-funding">--</h5>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card stat-card shadow-sm text-center">
                    <div class="card-body py-2">
                        <div class="text-muted small">Researchers</div>
                        <h5 class="text-navy mb-0" id="kpi-researchers">--</h5>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card stat-card shadow-sm text-center">
                    <div class="card-body py-2">
                        <div class="text-muted small">Publications</div>
                        <h5 class="text-navy mb-0" id="kpi-publications">--</h5>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card stat-card shadow-sm text-center">
                    <div class="card-body py-2">
                        <div class="text-muted small">VERSO Grants</div>
                        <h5 class="text-navy mb-0" id="kpi-grants">--</h5>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card stat-card shadow-sm text-center">
                    <div class="card-body py-2">
                        <div class="text-muted small">Total Matches</div>
                        <h5 class="text-navy mb-0" id="kpi-matches">--</h5>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card stat-card shadow-sm text-center">
                    <div class="card-body py-2">
                        <div class="text-muted small">Avg Match</div>
                        <h5 class="text-navy mb-0" id="kpi-avg-match">--</h5>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="analyticsTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="opportunities-tab" data-bs-toggle="tab" data-bs-target="#opportunities-pane" type="button" role="tab">
                    <i class="bi bi-file-earmark-text"></i> Opportunities
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="researchers-tab" data-bs-toggle="tab" data-bs-target="#researchers-pane" type="button" role="tab">
                    <i class="bi bi-people"></i> Researchers
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="matches-tab" data-bs-toggle="tab" data-bs-target="#matches-pane" type="button" role="tab">
                    <i class="bi bi-link-45deg"></i> Matches
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat-pane" type="button" role="tab">
                    <i class="bi bi-chat-dots text-danger"></i> <span class="text-danger">Ask AI</span>
                </button>
            </li>
        </ul>

        <div class="tab-content border border-top-0 rounded-bottom bg-white p-3" id="analyticsTabContent">

            <!-- ==================== Opportunities Tab ==================== -->
            <div class="tab-pane fade show active" id="opportunities-pane" role="tabpanel">

                <!-- Timeline Section -->
                <h5 class="text-navy mb-3 border-bottom pb-2"><i class="bi bi-graph-up"></i> Timeline</h5>
                <h6 class="text-navy mb-3">Opportunities Over Time</h6>
                <div class="chart-container mb-4">
                    <canvas id="chart-timeline"></canvas>
                </div>
                <h6 class="text-navy mb-3">Close Dates Over Time</h6>
                <div class="chart-container mb-4">
                    <canvas id="chart-close-dates"></canvas>
                </div>

                <!-- Funding Section -->
                <h5 class="text-navy mb-3 border-bottom pb-2 mt-4"><i class="bi bi-currency-dollar"></i> Funding</h5>
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <h6 class="text-navy mb-3">Award Ceiling Distribution</h6>
                        <div class="chart-container">
                            <canvas id="chart-funding-dist"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <h6 class="text-navy mb-3">Funding by Agency (Top 15)</h6>
                        <div class="chart-container chart-container-tall">
                            <canvas id="chart-funding-agency"></canvas>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <h6 class="text-navy mb-3">Funding Trends</h6>
                        <div class="chart-container">
                            <canvas id="chart-funding-trends"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <h6 class="text-navy mb-3">Avg Floor vs Ceiling by Agency</h6>
                        <div class="chart-container chart-container-tall">
                            <canvas id="chart-floor-ceiling"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Agencies Section -->
                <h5 class="text-navy mb-3 border-bottom pb-2 mt-4"><i class="bi bi-building"></i> Agencies</h5>
                <h6 class="text-navy mb-3">Agency Comparison by Status</h6>
                <div class="chart-container chart-container-tall mb-4">
                    <canvas id="chart-agency-comp"></canvas>
                </div>
                <h6 class="text-navy mb-3">Agency Activity Over Time (Top 8)</h6>
                <div class="chart-container mb-4">
                    <canvas id="chart-agency-activity"></canvas>
                </div>
                <h6 class="text-navy mb-3">Agency x Category (Bubble Chart)</h6>
                <div class="chart-container chart-container-tall mb-4">
                    <canvas id="chart-agency-category"></canvas>
                </div>

                <!-- Categories Section -->
                <h5 class="text-navy mb-3 border-bottom pb-2 mt-4"><i class="bi bi-tags"></i> Categories</h5>
                <h6 class="text-navy mb-3">Funding by Category</h6>
                <div class="chart-container mb-4">
                    <canvas id="chart-cat-funding"></canvas>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <h6 class="text-navy mb-3">Classification Breakdown</h6>
                        <div class="chart-container">
                            <canvas id="chart-classification"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <h6 class="text-navy mb-3">Classification Trends</h6>
                        <div class="chart-container">
                            <canvas id="chart-classif-trends"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== Researchers Tab ==================== -->
            <div class="tab-pane fade" id="researchers-pane" role="tabpanel">
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <h6 class="text-navy mb-3">Researchers by Department (Top 15)</h6>
                        <div class="chart-container chart-container-tall">
                            <canvas id="chart-res-dept"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <h6 class="text-navy mb-3">Researcher Status</h6>
                        <div class="chart-container">
                            <canvas id="chart-res-status"></canvas>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <h6 class="text-navy mb-3">Top Research Keywords (Top 20)</h6>
                        <div class="chart-container chart-container-tall">
                            <canvas id="chart-res-keywords"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <h6 class="text-navy mb-3">Publications Over Time</h6>
                        <div class="chart-container">
                            <canvas id="chart-pub-time"></canvas>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <h6 class="text-navy mb-3">VERSO Grant Funding by Funder (Top 15)</h6>
                        <div class="chart-container chart-container-tall">
                            <canvas id="chart-grant-funder"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <h6 class="text-navy mb-3">VERSO Activity Types</h6>
                        <div class="chart-container">
                            <canvas id="chart-act-types"></canvas>
                        </div>
                    </div>
                </div>
                <h6 class="text-navy mb-3">Researcher Engagement (Top 15)</h6>
                <div class="chart-container chart-container-tall mb-4">
                    <canvas id="chart-res-engage"></canvas>
                </div>
            </div>

            <!-- ==================== Matches Tab ==================== -->
            <div class="tab-pane fade" id="matches-pane" role="tabpanel">
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <h6 class="text-navy mb-3">Score Distribution</h6>
                        <div class="chart-container">
                            <canvas id="chart-match-dist"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <h6 class="text-navy mb-3">Score Component Breakdown</h6>
                        <div class="chart-container">
                            <canvas id="chart-match-comp"></canvas>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <h6 class="text-navy mb-3">Top-Matched Researchers (Top 15)</h6>
                        <div class="chart-container chart-container-tall">
                            <canvas id="chart-match-researchers"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <h6 class="text-navy mb-3">Top-Matched Opportunities (Top 15)</h6>
                        <div class="chart-container chart-container-tall">
                            <canvas id="chart-match-opportunities"></canvas>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <h6 class="text-navy mb-3">Match Quality by Department (Top 15)</h6>
                        <div class="chart-container chart-container-tall">
                            <canvas id="chart-match-dept"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <h6 class="text-navy mb-3">Match Quality by Agency (Top 15)</h6>
                        <div class="chart-container chart-container-tall">
                            <canvas id="chart-match-agency"></canvas>
                        </div>
                    </div>
                </div>
                <!-- Coverage Analysis -->
                <h6 class="text-navy mb-3">Coverage Analysis</h6>
                <div class="row" id="coverage-cards">
                    <div class="col-md-3 mb-3">
                        <div class="card bg-light text-center">
                            <div class="card-body py-3">
                                <div class="text-muted small">Opportunity Coverage</div>
                                <h4 class="text-navy mb-0" id="coverage-opp-pct">--</h4>
                                <div class="text-muted small" id="coverage-opp-detail"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-light text-center">
                            <div class="card-body py-3">
                                <div class="text-muted small">Researcher Coverage</div>
                                <h4 class="text-navy mb-0" id="coverage-res-pct">--</h4>
                                <div class="text-muted small" id="coverage-res-detail"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-light text-center">
                            <div class="card-body py-3">
                                <div class="text-muted small">Total Matches</div>
                                <h4 class="text-navy mb-0" id="coverage-total">--</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-light text-center">
                            <div class="card-body py-3">
                                <div class="text-muted small">Strong Matches</div>
                                <h4 class="text-navy mb-0" id="coverage-strong">--</h4>
                                <div class="text-muted small" id="coverage-threshold"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== Chat Tab ==================== -->
            <div class="tab-pane fade" id="chat-pane" role="tabpanel">
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages">
                        <div class="chat-bubble chat-assistant" id="chat-welcome">
                            <p class="mb-2">I can help you explore the grant opportunities, researcher, and match data. Try asking questions like:</p>
                            <ul class="small mb-2">
                                <li>"How many open opportunities are there?"</li>
                                <li>"Show me top 10 agencies by total funding"</li>
                                <li>"List the 5 largest awards closing this month"</li>
                                <li>"What is the average award ceiling for NSF grants?"</li>
                                <li>"Which categories have the most team-based opportunities?"</li>
                            </ul>
                            <p class="mb-2"><i class="bi bi-people"></i> <strong>Researcher &amp; Match Queries:</strong></p>
                            <ul class="small mb-2">
                                <li>"How many researchers are in the database?"</li>
                                <li>"Top departments by researcher count"</li>
                                <li>"Show the best researcher-opportunity matches"</li>
                                <li>"What is the average match score by department?"</li>
                                <li>"Which researchers have the most publications?"</li>
                            </ul>
                            <p class="mb-2 text-danger"><i class="bi bi-bar-chart"></i> <strong>Visualizations</strong> &mdash; use words like <em>plot</em>, <em>chart</em>, <em>graph</em>, or <em>visualize</em> to generate charts:</p>
                            <ul class="small mb-0 text-danger">
                                <li>"Plot the top 10 agencies by funding"</li>
                                <li>"Show a <strong>pie chart</strong> of opportunities by status"</li>
                                <li>"Graph publications per month as a <strong>line chart</strong>"</li>
                                <li>"Visualize match score distribution as a <strong>bar chart</strong>"</li>
                            </ul>
                        </div>
                    </div>
                    <form id="chat-form" class="chat-input-form">
                        <div class="input-group">
                            <input type="text" class="form-control" id="chat-input" placeholder="Ask a question about the data..." autocomplete="off">
                            <button class="btn btn-outline-secondary" type="button" id="chat-clear" title="Clear chat and start over">
                                <i class="bi bi-trash"></i>
                            </button>
                            <button class="btn btn-navy" type="submit" id="chat-send">
                                <i class="bi bi-send"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/analytics.js?v=0.5.0"></script>
<script src="/static/js/chat.js?v=0.5.0"></script>
{% endblock %}
