{% for opp in opportunities %}
<div class="card border-0 shadow-sm mb-3 opp-card">
    <div class="card-body">
        <div class="row">
            <div class="col-md-8">
                <h6 class="mb-1">
                    <a href="/opportunity/{{ opp.opportunity_id }}" class="text-navy text-decoration-none">
                        {{ opp.title }}
                    </a>
                </h6>
                <div class="small text-muted mb-2">
                    {% if opp.opportunity_number %}
                    <span class="me-2"><i class="bi bi-hash"></i> {{ opp.opportunity_number }}</span>
                    {% endif %}
                    {% if opp.agency %}
                    <span class="me-2"><i class="bi bi-building"></i> {{ opp.agency.name }}</span>
                    {% endif %}
                </div>
                <div class="d-flex flex-wrap gap-1 mb-2">
                    <!-- Status badge -->
                    {% if opp.status == 'posted' %}
                    <span class="badge bg-success">Posted</span>
                    {% elif opp.status == 'forecasted' %}
                    <span class="badge bg-info">Forecasted</span>
                    {% elif opp.status == 'closed' %}
                    <span class="badge bg-secondary">Closed</span>
                    {% elif opp.status == 'archived' %}
                    <span class="badge bg-dark">Archived</span>
                    {% endif %}

                    <!-- Category tags -->
                    {% for cat in opp.funding_categories[:3] %}
                    <span class="badge bg-light text-navy">{{ cat.category_name }}</span>
                    {% endfor %}

                    <!-- Collaboration badges -->
                    {% if opp.is_team_based %}
                    <span class="badge bg-purple-light">Team-Based</span>
                    {% endif %}
                    {% if opp.is_multi_institution %}
                    <span class="badge bg-purple-light">Multi-Institution</span>
                    {% endif %}
                    {% if opp.is_multi_disciplinary %}
                    <span class="badge bg-purple-light">Multi-Disciplinary</span>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-4 text-md-end">
                <!-- Close date with urgency color -->
                {% if opp.close_date %}
                    {% set days_left = (opp.close_date - today).days if today else 0 %}
                    {% if days_left <= 7 and days_left >= 0 %}
                    <div class="text-danger fw-bold small">
                        <i class="bi bi-exclamation-triangle"></i> Closes {{ opp.close_date.strftime('%b %d, %Y') }}
                    </div>
                    {% elif days_left <= 30 and days_left >= 0 %}
                    <div class="text-warning fw-bold small">
                        <i class="bi bi-clock"></i> Closes {{ opp.close_date.strftime('%b %d, %Y') }}
                    </div>
                    {% else %}
                    <div class="text-muted small">
                        <i class="bi bi-calendar"></i> Closes {{ opp.close_date.strftime('%b %d, %Y') }}
                    </div>
                    {% endif %}
                {% elif opp.close_date_description %}
                <div class="text-muted small">
                    <i class="bi bi-calendar"></i> {{ opp.close_date_description[:60] }}
                </div>
                {% else %}
                <div class="text-muted small">No deadline specified</div>
                {% endif %}

                {% if opp.award_ceiling %}
                <div class="text-navy fw-bold mt-1">
                    ${{ "{:,.0f}".format(opp.award_ceiling) }}
                </div>
                <div class="text-muted small">Award Ceiling</div>
                {% endif %}

                {% if opp.funding_instrument_description %}
                <div class="text-muted small mt-1">{{ opp.funding_instrument_description }}</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="text-center py-5">
    <i class="bi bi-search display-4 text-muted"></i>
    <p class="text-muted mt-2">No opportunities found. Try adjusting your filters.</p>
</div>
{% endfor %}

<!-- Pagination -->
{% if total_pages > 1 %}
<nav aria-label="Search results pages" class="mt-3">
    <ul class="pagination justify-content-center">
        {% if page > 1 %}
        <li class="page-item">
            <a class="page-link" href="#" onclick="goToPage({{ page - 1 }}); return false;">&laquo; Prev</a>
        </li>
        {% endif %}

        {% for p in range(1, total_pages + 1) %}
            {% if p == page %}
            <li class="page-item active"><span class="page-link">{{ p }}</span></li>
            {% elif p <= 3 or p > total_pages - 3 or (p >= page - 2 and p <= page + 2) %}
            <li class="page-item">
                <a class="page-link" href="#" onclick="goToPage({{ p }}); return false;">{{ p }}</a>
            </li>
            {% elif p == 4 or p == total_pages - 3 %}
            <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
        {% endfor %}

        {% if page < total_pages %}
        <li class="page-item">
            <a class="page-link" href="#" onclick="goToPage({{ page + 1 }}); return false;">Next &raquo;</a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}
